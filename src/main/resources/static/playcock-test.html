<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Playcock Admin (Readable)</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 16px; line-height: 1.35; }
        h1 { margin: 0 0 12px; }
        h2 { margin: 0 0 10px; font-size: 18px; }
        h3 { margin: 14px 0 8px; font-size: 16px; }
        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .box { border: 1px solid #ddd; padding: 12px; border-radius: 10px; margin-bottom: 12px; }
        input, select, button { padding: 8px; }
        button { cursor:pointer; }
        .muted { color:#666; font-size: 13px; }
        .grid { display:grid; grid-template-columns: 1fr 1.2fr; gap:12px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        pre { background:#f7f7f7; padding: 10px; border-radius: 10px; overflow:auto; max-height: 300px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #eee; padding: 8px; font-size: 13px; vertical-align: top; }
        th { background:#fafafa; text-align:left; position: sticky; top: 0; z-index: 1; }
        .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:12px; margin-right:6px; }
        .ok { border-color: #b8e2b8; background:#effaef; }
        .warn { border-color:#f3d1a1; background:#fff7ea; }
        .bad { border-color:#f0b4b4; background:#fff0f0; }
        .sectionTitle { display:flex; justify-content:space-between; align-items:center; gap:10px; }
        .clickable { color: #0b66c3; cursor: pointer; text-decoration: underline; }
        .small { font-size: 12px; color: #666; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .twoCol { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 900px) { .twoCol { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<h1>ğŸ¸ Playcock í†µí•© ê´€ë¦¬ì í…ŒìŠ¤íŠ¸ (ë³´ê¸° ì‰¬ìš´ ë²„ì „)</h1>
<div class="muted">
    ê°™ì€ ì„œë²„(<code>localhost:8080</code>)ì—ì„œ HTMLì„ ì„œë¹™í•˜ë©´ CORS ì—†ì´ ë°”ë¡œ ë™ì‘í•©ë‹ˆë‹¤.
    <br/>ì£¼ì†Œ: <code>http://localhost:8080/playcock-admin.html</code>
</div>

<div class="grid">

    <!-- LEFT -->
    <div>

        <div class="box">
            <div class="sectionTitle">
                <h2>1) ë©¤ë²„ ë“±ë¡</h2>
                <div class="row">
                    <button onclick="loadPlayers()">ë©¤ë²„ ìƒˆë¡œê³ ì¹¨</button>
                    <button onclick="loadDashboard()">ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>

            <div class="row">
                <input id="pName" placeholder="ì´ë¦„ (ì˜ˆ: ì² ìˆ˜)" />
                <select id="pType">
                    <option value="MEMBER">MEMBER(ë¶€ì›)</option>
                    <option value="GUEST">GUEST(ê²ŒìŠ¤íŠ¸)</option>
                    <option value="ETC">ETC(ê¸°íƒ€)</option>
                </select>
                <select id="pGender">
                    <option value="MALE">MALE(ë‚¨)</option>
                    <option value="FEMALE">FEMALE(ì—¬)</option>
                </select>
                <button onclick="createPlayer()">ë“±ë¡</button>
            </div>
            <div class="small">â€» ì„œë²„ enumì´ MALE/FEMALE, MEMBER/GUEST/ETC ê¸°ì¤€ì¼ ë•Œ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥</div>
        </div>

        <div class="box">
            <div class="sectionTitle">
                <h2>2) ë©¤ë²„ ëª©ë¡ & ì„¸ì…˜ ì°¸ê°€ì ì„ íƒ</h2>
                <div class="row">
                    <button onclick="selectAllPlayers()">ì „ì²´ ì„ íƒ</button>
                    <button onclick="clearSelectedPlayers()">ì„ íƒ í•´ì œ</button>
                </div>
            </div>

            <div class="row">
                <button onclick="startSessionFromSelected()">ì„¸ì…˜ ì‹œì‘(ì„ íƒ ë©¤ë²„)</button>
                <button onclick="endSession()">ì„¸ì…˜ ì¢…ë£Œ(end)</button>
                <button onclick="loadDashboard()">ëŒ€ì‹œë³´ë“œ ì¡°íšŒ</button>
            </div>

            <div class="muted" style="margin-top:8px;">ì„¸ì…˜ ì‹œì‘í•  ë©¤ë²„ë¥¼ ì²´í¬í•˜ì„¸ìš”.</div>
            <div style="margin-top:10px; overflow:auto; max-height:320px;">
                <table>
                    <thead>
                    <tr>
                        <th>ì„ íƒ</th>
                        <th>ID</th>
                        <th>ì´ë¦„</th>
                        <th>ìœ í˜•</th>
                        <th>ì„±ë³„</th>
                    </tr>
                    </thead>
                    <tbody id="playersTbody"></tbody>
                </table>
            </div>
        </div>

        <div class="box">
            <div class="sectionTitle">
                <h2>3) WAITING íŒ€ ë§Œë“¤ê¸°</h2>
                <button onclick="loadDashboard()">ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div class="muted">
                LISTì—ì„œ 1~4ëª…ì„ ê³¨ë¼ íŒ€ì„ ë§Œë“¤ì–´ WAITING íì— ìŒ“ìŠµë‹ˆë‹¤.
                <br/>íŒ: ì•„ë˜ LIST í‘œì—ì„œ IDë“¤ì„ ë³´ê³  <span class="mono">1,2,3</span> ê°™ì´ ì…ë ¥í•˜ì„¸ìš”.
            </div>

            <div class="row" style="margin-top:10px;">
                <input id="waitingPickIds" placeholder="LISTì—ì„œ ê³ ë¥¼ IDë“¤ (ì˜ˆ: 1,2,3)" style="width:260px;" />
                <button onclick="createWaitingTeam()">ëŒ€ê¸°íŒ€ ìƒì„±</button>
            </div>

            <div class="row" style="margin-top:10px;">
                <input id="deleteTeamId" placeholder="waitingTeamId (í´ë¦­ìœ¼ë¡œ ìë™ì…ë ¥ë¨)" style="width:260px;" />
                <button onclick="deleteWaitingTeam()">ëŒ€ê¸°íŒ€ ì‚­ì œ(í•´ì²´â†’LIST)</button>
            </div>
        </div>

        <div class="box">
            <div class="sectionTitle">
                <h2>4) ê²½ê¸° ì‹œì‘/ì¢…ë£Œ</h2>
                <button onclick="loadDashboard()">ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div class="row">
                <input id="startMatchTeamId" placeholder="waitingTeamId (í´ë¦­ìœ¼ë¡œ ìë™ì…ë ¥ë¨)" style="width:260px;" />
                <button onclick="startMatch()">ê²½ê¸° ì‹œì‘(WAITINGâ†’PLAYING)</button>
            </div>

            <div class="row" style="margin-top:10px;">
                <input id="endMatchId" placeholder="matchId (í´ë¦­ìœ¼ë¡œ ìë™ì…ë ¥ë¨)" style="width:260px;" />
                <button onclick="endMatch()">ê²½ê¸° ì¢…ë£Œ(PLAYINGâ†’LIST)</button>
            </div>

            <div class="muted" style="margin-top:10px;">
                ì´ ê²½ê¸° ìˆ˜ëŠ” â€œê²½ê¸° ì‹œì‘â€í•  ë•Œë§ˆë‹¤ <b>+1</b> ë©ë‹ˆë‹¤. (matchNo ì¦ê°€)
            </div>
        </div>

    </div>

    <!-- RIGHT -->
    <div>

        <div class="box">
            <div class="sectionTitle">
                <h2>ì„¸ì…˜ ìš”ì•½</h2>
                <div class="row">
                    <button onclick="loadDashboard()">ëŒ€ì‹œë³´ë“œ ì¡°íšŒ</button>
                    <button onclick="toggleRawJson()">RAW JSON í† ê¸€</button>
                </div>
            </div>

            <div id="sessionSummary" class="muted"></div>

            <div class="twoCol" style="margin-top:10px;">
                <div>
                    <h3>LIST (íœ´ì‹/ê²½ê¸°ìˆ˜)</h3>
                    <div style="overflow:auto; max-height:260px;">
                        <table>
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>ì´ë¦„</th>
                                <th>ì„±ë³„</th>
                                <th>íœ´ì‹</th>
                                <th>ê²½ê¸°ìˆ˜(ë‚¨/ì—¬/í˜¼/ì´)</th>
                            </tr>
                            </thead>
                            <tbody id="listTbody"></tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h3>WAITING íŒ€</h3>
                    <div style="overflow:auto; max-height:260px;">
                        <table>
                            <thead>
                            <tr>
                                <th>teamId</th>
                                <th>ìƒì„±</th>
                                <th>ë©¤ë²„</th>
                            </tr>
                            </thead>
                            <tbody id="waitingTbody"></tbody>
                        </table>
                    </div>
                    <div class="small">teamId í´ë¦­ â†’ ì•„ë˜ ì…ë ¥ì¹¸ ìë™ ì±„ì›€</div>
                </div>
            </div>

            <div style="margin-top:14px;">
                <h3>PLAYING ê²½ê¸°</h3>
                <div style="overflow:auto; max-height:320px;">
                    <table>
                        <thead>
                        <tr>
                            <th>matchId</th>
                            <th>ë²ˆí˜¸</th>
                            <th>íƒ€ì…</th>
                            <th>ì‹œì‘</th>
                            <th>ì§„í–‰ì‹œê°„</th>
                            <th>ë©¤ë²„</th>
                        </tr>
                        </thead>
                        <tbody id="playingTbody"></tbody>
                    </table>
                </div>
                <div class="small">matchId í´ë¦­ â†’ ì¢…ë£Œ ì…ë ¥ì¹¸ ìë™ ì±„ì›€</div>
            </div>

            <div id="rawJsonWrap" style="display:none; margin-top:12px;">
                <h3>RAW JSON</h3>
                <pre id="dashboardJson"></pre>
            </div>
        </div>

        <div class="box">
            <div class="sectionTitle">
                <h2>ğŸ“Œ ì„œë²„ ì‘ë‹µ(ë§ˆì§€ë§‰ ìš”ì²­)</h2>
                <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            </div>
            <pre id="result"></pre>
        </div>

    </div>

</div>

<script>
    const API = ""; // ê°™ì€ ì„œë²„ì—ì„œ ì„œë¹™í•˜ë¯€ë¡œ ë¹ˆ ë¬¸ìì—´ì´ë©´ ìƒëŒ€ê²½ë¡œ ì‚¬ìš©ë¨
    let latestDashboard = null;
    let rawJsonVisible = false;

    // ===== util =====
    function show(obj) {
        document.getElementById("result").textContent = JSON.stringify(obj, null, 2);
    }
    function showText(text) {
        document.getElementById("result").textContent = String(text);
    }
    function clearLog() {
        document.getElementById("result").textContent = "";
    }
    function toggleRawJson() {
        rawJsonVisible = !rawJsonVisible;
        document.getElementById("rawJsonWrap").style.display = rawJsonVisible ? "block" : "none";
        if (rawJsonVisible && latestDashboard) {
            document.getElementById("dashboardJson").textContent = JSON.stringify(latestDashboard, null, 2);
        }
    }

    async function fetchJson(url, options) {
        const res = await fetch(API + url, options);
        const text = await res.text();
        let body;
        try { body = text ? JSON.parse(text) : null; } catch { body = text; }

        if (!res.ok) {
            const err = { status: res.status, statusText: res.statusText, url, body };
            show(err);
            throw err;
        }
        return body;
    }

    function parseIds(input) {
        return input.split(",")
            .map(s => s.trim())
            .filter(Boolean)
            .map(Number)
            .filter(n => !Number.isNaN(n));
    }

    function secondsToHuman(sec) {
        if (sec == null) return "-";
        const s = Math.max(0, Number(sec));
        const m = Math.floor(s / 60);
        const r = s % 60;
        if (m <= 0) return `${r}s`;
        return `${m}m ${r}s`;
    }

    function isoToKST(iso) {
        if (!iso) return "-";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleString("ko-KR");
    }

    function pick(obj, ...keys) {
        for (const k of keys) if (obj && obj[k] != null) return obj[k];
        return null;
    }

    // ===== ClubPlayer =====
    async function loadPlayers() {
        const data = await fetchJson("/club-players", { method: "GET" });
        renderPlayersTable(data);
        show({ ok: true, action: "GET /club-players", data });
    }

    function renderPlayersTable(players) {
        const tbody = document.getElementById("playersTbody");
        tbody.innerHTML = "";

        (players || []).forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td><input type="checkbox" class="playerCheck" data-id="${p.id}"/></td>
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.type}</td>
        <td>${p.gender}</td>
      `;
            tbody.appendChild(tr);
        });
    }

    async function createPlayer() {
        const name = document.getElementById("pName").value.trim();
        const type = document.getElementById("pType").value;
        const gender = document.getElementById("pGender").value;

        if (!name) {
            showText("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const payload = { name, type, gender };

        const data = await fetchJson("/club-players", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        show({ ok: true, action: "POST /club-players", payload, data });
        await loadPlayers();
    }

    function selectAllPlayers() {
        document.querySelectorAll(".playerCheck").forEach(ch => ch.checked = true);
    }

    function clearSelectedPlayers() {
        document.querySelectorAll(".playerCheck").forEach(ch => ch.checked = false);
    }

    function getSelectedPlayerIds() {
        return Array.from(document.querySelectorAll(".playerCheck"))
            .filter(ch => ch.checked)
            .map(ch => Number(ch.dataset.id));
    }

    // ===== Session =====
    async function startSessionFromSelected() {
        const ids = getSelectedPlayerIds();
        if (ids.length === 0) {
            showText("ì„¸ì…˜ ì‹œì‘í•  ë©¤ë²„ë¥¼ ì²´í¬í•˜ì„¸ìš”.");
            return;
        }

        const payload = { participantClubPlayerIds: ids };

        const data = await fetchJson("/sessions/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        show({ ok: true, action: "POST /sessions/start", payload, data });
        renderDashboard(data);
    }

    async function loadDashboard() {
        const data = await fetchJson("/sessions/current/dashboard", { method: "GET" });
        show({ ok: true, action: "GET /sessions/current/dashboard", data });
        renderDashboard(data);
    }

    function renderDashboard(d) {
        latestDashboard = d;

        // ìš”ì•½
        const sum = document.getElementById("sessionSummary");
        if (!d || !d.session) {
            sum.innerHTML = `<span class="pill bad">ì„¸ì…˜ ì—†ìŒ</span> /sessions/start ë¡œ ì„¸ì…˜ì„ ì‹œì‘í•˜ì„¸ìš”.`;
            document.getElementById("listTbody").innerHTML = "";
            document.getElementById("waitingTbody").innerHTML = "";
            document.getElementById("playingTbody").innerHTML = "";
            if (rawJsonVisible) document.getElementById("dashboardJson").textContent = JSON.stringify(d, null, 2);
            return;
        }

        sum.innerHTML = `
      <span class="pill ok">ACTIVE</span>
      <span class="pill">${"sessionId=" + d.session.sessionId}</span>
      <span class="pill">${"totalMatches=" + d.session.totalMatches}</span>
      <div class="small">startedAt: ${isoToKST(d.session.startedAt)}</div>
      <div class="small">
        LIST=${(d.list||[]).length}ëª… /
        WAITING=${(d.waitingTeams||[]).length}íŒ€ /
        PLAYING=${(d.playingMatches||[]).length}ê²½ê¸°
      </div>
    `;

        // RAW JSON
        if (rawJsonVisible) {
            document.getElementById("dashboardJson").textContent = JSON.stringify(d, null, 2);
        }

        // LIST í…Œì´ë¸” ë Œë”
        const listTbody = document.getElementById("listTbody");
        listTbody.innerHTML = "";
        (d.list || []).forEach(p => {
            // ì¹´ìš´íŠ¸ í•„ë“œ ì´ë¦„ì´ í”„ë¡œì íŠ¸ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ìœ ì—°í•˜ê²Œ ë°›ìŒ
            const maleC = Number(p.maleDoubleCount ?? 0);
            const femaleC = Number(p.femaleDoubleCount ?? 0);
            const mixedC = Number(p.mixedDoubleCount ?? 0);
            const totalC = Number(p.totalMatchCount ?? (maleC + femaleC + mixedC));

            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td class="mono">${p.clubPlayerId}</td>
        <td>${p.name}</td>
        <td>${p.gender}</td>
        <td>${secondsToHuman(p.restSeconds)}</td>
        <td class="mono">${maleC}/${femaleC}/${mixedC}/${totalC}</td>
      `;
            listTbody.appendChild(tr);
        });

        // WAITING í…Œì´ë¸” ë Œë”
        const waitingTbody = document.getElementById("waitingTbody");
        waitingTbody.innerHTML = "";
        (d.waitingTeams || []).forEach(t => {
            const members = (t.members || []).map(m => `${m.name}(${m.clubPlayerId})`).join(", ");
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>
          <span class="clickable mono" onclick="fillTeamId(${t.waitingTeamId})">${t.waitingTeamId}</span>
          <div class="small">
            <span class="clickable" onclick="fillStartMatchTeamId(${t.waitingTeamId})">â†’ ê²½ê¸°ì‹œì‘ ì…ë ¥</span> /
            <span class="clickable" onclick="fillDeleteTeamId(${t.waitingTeamId})">â†’ íŒ€ì‚­ì œ ì…ë ¥</span>
          </div>
        </td>
        <td>${isoToKST(t.createdAt)}</td>
        <td>${members}</td>
      `;
            waitingTbody.appendChild(tr);
        });

        // PLAYING í…Œì´ë¸” ë Œë”
        const playingTbody = document.getElementById("playingTbody");
        playingTbody.innerHTML = "";
        (d.playingMatches || []).forEach(m => {
            const members = (m.members || []).map(x => `${x.name}(${x.clubPlayerId})`).join(", ");
            const matchType = pick(m, "matchType", "type"); // ì„œë²„ê°€ matchTypeì„ ë‚´ë ¤ì¤„ ë•Œ
            const elapsedSeconds = pick(m, "elapsedSeconds", "elapsed", "progressSeconds"); // ì„œë²„ê°€ ì§„í–‰ì‹œê°„ ë‚´ë ¤ì¤„ ë•Œ

            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>
          <span class="clickable mono" onclick="fillEndMatchId(${m.matchId})">${m.matchId}</span>
          <div class="small"><span class="clickable" onclick="fillEndMatchId(${m.matchId})">â†’ ì¢…ë£Œ ì…ë ¥</span></div>
        </td>
        <td class="mono">${m.matchNo ?? "-"}</td>
        <td class="mono">${matchType ?? "-"}</td>
        <td>${isoToKST(m.startedAt)}</td>
        <td>${elapsedSeconds == null ? "-" : secondsToHuman(elapsedSeconds)}</td>
        <td>${members}</td>
      `;
            playingTbody.appendChild(tr);
        });
    }

    function fillTeamId(id) {
        fillStartMatchTeamId(id);
        fillDeleteTeamId(id);
    }
    function fillStartMatchTeamId(id) {
        document.getElementById("startMatchTeamId").value = id;
    }
    function fillDeleteTeamId(id) {
        document.getElementById("deleteTeamId").value = id;
    }
    function fillEndMatchId(id) {
        document.getElementById("endMatchId").value = id;
    }

    async function endSession() {
        await fetchJson("/sessions/current/end", { method: "POST" });
        show({ ok: true, action: "POST /sessions/current/end" });
    }

    // ===== Waiting Team =====
    async function createWaitingTeam() {
        const ids = parseIds(document.getElementById("waitingPickIds").value);
        if (ids.length < 1 || ids.length > 4) {
            showText("ëŒ€ê¸°íŒ€ì€ 1~4ëª… IDë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: 1,2,3");
            return;
        }

        const payload = { clubPlayerIds: ids };

        const data = await fetchJson("/waiting-teams", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        show({ ok: true, action: "POST /waiting-teams", payload, data });
        renderDashboard(data);
    }

    async function deleteWaitingTeam() {
        const teamId = Number(document.getElementById("deleteTeamId").value);
        if (!teamId) { showText("waitingTeamIdë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

        const data = await fetchJson(`/waiting-teams/${teamId}`, { method: "DELETE" });
        show({ ok: true, action: `DELETE /waiting-teams/${teamId}`, data });
        renderDashboard(data);
    }

    // ===== Match =====
    async function startMatch() {
        const teamId = Number(document.getElementById("startMatchTeamId").value);
        if (!teamId) { showText("waitingTeamIdë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

        const payload = { waitingTeamId: teamId };
        const data = await fetchJson("/matches/start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        show({ ok: true, action: "POST /matches/start", payload, data });
        renderDashboard(data);
    }

    async function endMatch() {
        const matchId = Number(document.getElementById("endMatchId").value);
        if (!matchId) { showText("matchIdë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

        const data = await fetchJson(`/matches/${matchId}/end`, { method: "POST" });
        show({ ok: true, action: `POST /matches/${matchId}/end`, data });
        renderDashboard(data);
    }

    // ===== init =====
    (async function init() {
        try {
            await loadPlayers();
        } catch (e) {
            show({ hint: "ë©¤ë²„ API(/club-players)ê°€ ì—†ê±°ë‚˜ ê²½ë¡œê°€ ë‹¤ë¥´ë©´ ê²½ë¡œë¥¼ ë§ì¶°ì£¼ì„¸ìš”.", error: e });
        }
    })();
</script>

</body>
</html>
